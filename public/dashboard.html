<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; display: flex; }
  nav { width: 220px; background: #2c3e50; color: white; min-height: 100vh; padding: 20px; }
  nav h3 { margin-top: 0; }
  nav a { color: white; display: block; margin: 15px 0; text-decoration: none; cursor: pointer; }
  .content { flex: 1; padding: 30px; background: #f4f4f4; min-height: 100vh; }
  .section { display: none; }
  .section.active { display: block; }
  .card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px gray; }
  form { background: white; padding: 20px; border-radius: 8px; max-width: 400px; box-shadow: 0 0 10px gray; }
  input, textarea, button { padding: 10px; margin-top: 10px; width: 100%; }
  button { background: teal; color: white; border: none; cursor: pointer; }
  button:hover { background: darkcyan; }
</style>
</head>
<body>

<nav>
  <h3>User Dashboard</h3>
  <a onclick="showSection('bookingsSection')">My Bookings</a>
  <a onclick="showSection('packagesSection')">Packages</a>
  <a onclick="showSection('activitiesSection')">Activities</a>
  <a onclick="logout()">Logout</a>
</nav>

<div class="content">
  <div id="bookingsSection" class="section active">
    <h2>My Bookings</h2>
    <div id="bookingsList"></div>
  </div>

  <div id="packagesSection" class="section">
    <h2>Available Packages</h2>
    <div id="packagesList"></div>
  </div>

  <div id="activitiesSection" class="section">
    <h2>Available Activities</h2>
    <div id="activitiesList"></div>
  </div>
</div>

<script>
const API_BASE = "https://mindandmedicineholidays.onrender.com";

// âœ… Check token and role immediately
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
if (!token || role !== "user") {
  alert("You must be logged in as a user!");
  window.location.href = "login.html";
}

// Navigation
function showSection(id){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');

  if(id==='bookingsSection') loadBookings();
  if(id==='packagesSection') loadPackages();
  if(id==='activitiesSection') loadActivities();
}

// Load user bookings
async function loadBookings(){
  try {
    const res = await fetch(`${API_BASE}/api/bookings/user`, { headers: { Authorization: `Bearer ${token}` }});
    const bookings = await res.json();
    const container = document.getElementById("bookingsList");
    container.innerHTML = bookings.length ? "" : "<p>No bookings yet.</p>";
    bookings.forEach(b => {
      const div = document.createElement("div");
      div.classList.add("card");
      div.innerHTML = `<p><strong>Package:</strong> ${b.packageTitle || "N/A"}</p>
                       <p><strong>Activity:</strong> ${b.activityName || "N/A"}</p>
                       <p><strong>Status:</strong> ${b.status}</p>`;
      container.appendChild(div);
    });
  } catch(err){ alert("Failed to load bookings! " + err); }
}

// Load packages
async function loadPackages(){
  try {
    const res = await fetch(`${API_BASE}/api/packages`, { headers: { Authorization: `Bearer ${token}` }});
    const packages = await res.json();
    const container = document.getElementById("packagesList");
    container.innerHTML = packages.length ? "" : "<p>No packages yet.</p>";
    packages.forEach(p => {
      const div = document.createElement("div");
      div.classList.add("card");
      div.innerHTML = `<h3>${p.title}</h3><img src="${API_BASE}${p.image}" alt="${p.title}"><p>Price: $${p.price}</p>`;
      container.appendChild(div);
    });
  } catch(err){ alert("Failed to load packages! " + err); }
}

// Load activities
async function loadActivities(){
  try {
    const res = await fetch(`${API_BASE}/api/activities`, { headers: { Authorization: `Bearer ${token}` }});
    const activities = await res.json();
    const container = document.getElementById("activitiesList");
    container.innerHTML = activities.length ? "" : "<p>No activities yet.</p>";
    activities.forEach(a => {
      const div = document.createElement("div");
      div.classList.add("card");
      div.innerHTML = `<h3>${a.name}</h3><img src="${API_BASE}${a.image}" alt="${a.name}"><p>${a.description}</p><p>Location: ${a.location || "N/A"}</p>`;
      container.appendChild(div);
    });
  } catch(err){ alert("Failed to load activities! " + err); }
}

// Logout
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("role");
  localStorage.removeItem("user");
  window.location.href = "login.html";
}

// Initial load
loadBookings();
loadPackages();
loadActivities();
</script>

</body>
</html>
